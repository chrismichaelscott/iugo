/* copyright Factmint Ltd 2014, Licence MIT, author chris.scott@factmint.com */
'use strict';window.$iugo={};$iugo.$internals={};$iugo.$internals.registerModelMember=function(a,b){Object.defineProperty(a,b,{get:function(){return this.$[b]},set:function(c){window.Promise&&c instanceof Promise?c.then(function(e){a[b]=e}):(this.updateView(b,c),this.$[b]=c,$iugo.$internals.applySetters(c,this,[b],c))}})};
$iugo.$internals.applySetters=function(a,b,c,e){if(a instanceof Object||a instanceof Array){for(var d in a){$iugo.$internals.registerProperty(a,d,b,c);var f=c.concat([d]);$iugo.$internals.applySetters(a[d],b,f,e)}a instanceof Array&&$iugo.$internals.registerArray(a,b,c)}};
$iugo.$internals.registerProperty=function(a,b,c,e){c.$[e.concat([b]).join(".")]=a[b];Object.defineProperty(a,b,{get:function(){return c.$[e.concat([b]).join(".")]},set:function(d){c.$[e.concat([b]).join(".")]=d;$iugo.$internals.setChildMembers(a,c,e);c.updateView(e[0],c[e[0]])}})};$iugo.$internals.setChildMembers=function(a,b,c){if(a instanceof Object||a instanceof Array)for(var e in a){var d=c.concat([e]);b.$[d.join(".")]=a[e];$iugo.$internals.setChildMembers(a[e],b,d)}};
$iugo.$internals.registerArray=function(a,b,c){a.push=function(){var a=Array.prototype.push.apply(this,arguments);b[c[0]]=b[c[0]];return a};a.pop=function(){var e=$iugo.$internals.clone(Array.prototype.pop.call(a));b[c[0]]=b[c[0]];return e};a.unshift=function(){for(var a=$iugo.$internals.clone(this),d=0;d<arguments.length;d++)this[d]=arguments[d];for(var f=0;f<a.length;f++)this[d++]=a[f];b[c[0]]=b[c[0]];return this.length};a.shift=function(){var a=$iugo.$internals.clone(Array.prototype.shift.call(this));
b[c[0]]=b[c[0]];return a};a.reverse=function(){for(var a=$iugo.$internals.clone(this),c=0;c<this.length;c++)this[c]=a[this.length-1-c];return this};a.sort=function(){var a=$iugo.$internals.clone(this);Array.prototype.sort.apply(a,arguments);for(var c=0;c<this.length;c++)this[c]=a[c];return this};a.splice=function(){for(var a=$iugo.$internals.clone(this),d=0;d<a.length,d<arguments[0];d++)this[d]=a[d];for(var f=2;f<arguments.length;f++)this[d++]=arguments[f];for(f=arguments[0]+arguments[1];f<a.length;f++)this[d++]=
a[f];for(f=d;f<a.length;f++)this.pop();b[c[0]]=b[c[0]];return this}};$iugo.$internals.clone=function(a){var b;b=a instanceof Array?[]:{};for(var c in a)b[c]=a[c]instanceof Object||a[c]instanceof Array?$iugo.$internals.clone(a[c]):a[c];return b};
$iugo.$internals.MVVC=function(a,b){this.store={};this.scope=b?b:document.body;this.controller={};this.viewcontroller={};for(var c=0;c<this.initializers.length;c++)if(this.initializers[c]instanceof Function)this.initializers[c](this);this.$={};for(var e in a)$iugo.$internals.registerModelMember(this,e),this[e]=a[e]};
$iugo.$internals.MVVC.prototype={updateView:function(a,b){for(var c=0;c<this.defaultViewcontrollers.length;c++)if(this.defaultViewcontrollers[c]instanceof Function)this.defaultViewcontrollers[c](a,b,this.scope,this.store);if("undefined"!==typeof this.viewcontroller[a]&&this.viewcontroller[a]instanceof Function)this.viewcontroller[a](b,this.scope,this.store)},defaultViewcontrollers:[],initializers:[]};$iugo.defaultViewcontrollers=$iugo.$internals.MVVC.prototype.defaultViewcontrollers;
$iugo.initializers=$iugo.$internals.MVVC.prototype.initializers;window.Iugo=function(a,b){return new $iugo.$internals.MVVC(a,b)};
$iugo.initializers.push(function(a){a.store.tags={};a.store.namespacedTagIndex={};a.store.idCounter=0;for(var b=/(>[^<]*)\{\{([^:.}<]+:)?([^}<]*)\}\}([^<]*<)/g;a.scope.innerHTML.match(b);)a.scope.innerHTML=a.scope.innerHTML.replace(b,function(a,b,d,f,k){a=b+"<span ";d&&(a+='class="bindto-'+d.substr(0,d.length-1)+'" ');return a+('data-path="'+f+'"></span>'+k)});a.scope.innerHTML=a.scope.innerHTML.replace(/<[^>]+ [^ =]+="[^"]*\{\{[^}<"]+\}\}[^"]*"[^>]*>/g,function(c){var b=a.store.idCounter++;a.store.tags[b]=
{bindAttributes:[],attributeTemplates:{},replacements:{}};c=c.replace(/([^ =]+)="([^"]*\{\{[^}"]+\}\}[^"]*)"/g,function(c,f,k){"data-iugo_alias-"==f.substr(0,16)&&(f=f.substr(16));a.store.tags[b].bindAttributes.push(f);a.store.tags[b].attributeTemplates[f]=k;k.replace(/\{\{([^"}:]+):[^}"]+\}\}/g,function(c,d){a.store.namespacedTagIndex[d]||(a.store.namespacedTagIndex[d]=[]);-1==a.store.namespacedTagIndex[d].indexOf(b)&&a.store.namespacedTagIndex[d].push(b)});return f+'=""'});return c=c.replace(/ ?>$/,
' data-iugo_id="'+b+'">')})});
$iugo.defaultViewcontrollers.push(function(a,b,c,e){function d(a){for(var c=document.querySelector('[data-iugo_id="'+a+'"]'),b=e.tags[a].bindAttributes,d=0;d<b.length;d++){var f=e.tags[a].attributeTemplates[b[d]].replace(m,function(b){return e.tags[a].replacements[b]?e.tags[a].replacements[b]:""});c.setAttribute(b[d],f)}}function f(a,b,c){if(b.hasAttribute("data-iugo_id")){var f=b.getAttribute("data-iugo_id");b=function(b,d,p){if(!d&&!c||d&&d.substr(0,d.length-1)==c){d=p.split(".");p=a;for(var g=
0;g<d.length;g++)""!==d[g]&&(p=p[d[g]]);e.tags[f].replacements[b]=p}};for(var k=e.tags[f].bindAttributes,g=0;g<k.length;g++)e.tags[f].attributeTemplates[k[g]].replace(m,b);d(f)}}function k(a){var b=a.getAttribute("data-iugo_id"),c=e.idCounter++,b=e.tags[b];e.tags[c]={bindAttributes:b.bindAttributes,attributeTemplates:b.attributeTemplates,replacements:{}};a.setAttribute("data-iugo_id",c)}function g(a,b,c){f(a,b);if(a instanceof Array){c=b.children.length;for(var d=c-1;0<=d;d--)b.children[d].classList.contains("iugo_cloned")&&
b.removeChild(b.children[d]);c=b.children.length;for(d=0;d<c;d++){var e;if(b.children[d].hasAttribute("data-each")){e=b.children[d];0===a.length?(e.setAttribute("data-iugo_display",e.style.display),e.style.display="none"):e.style.display=e.getAttribute("data-iugo_display");for(var l=0;l<a.length;l++){var h;if(1<=l){h=e.cloneNode(!0);h.classList.add("iugo_cloned");h.hasAttribute("data-iugo_id")&&k(h);for(var m=h.querySelectorAll("[data-iugo_id]"),n=0;n<m.length;n++)k(m[n]);b.appendChild(h)}else h=
e;g(a[l],h)}}}}else if(a instanceof Object)if(d=b.getAttribute("data-path"),null!=d&&""!==d)c=null==c?"":c+".",d=d.slice(c.length).split(".")[0],g(a[d],b,c+d);else for(d=0;d<b.children.length;d++)b.children[d].className.match("bindto-")||g(a,b.children[d],c);else if(0<b.children.length)for(d=0;d<b.children.length;d++)g(a,b.children[d],c);else"INPUT"==b.tagName?b.value=a:b.innerHTML=a}var m=/\{\{([^:}]+:)?([^}]+)\}\}/g;if(e.namespacedTagIndex[a])for(var h=e.namespacedTagIndex[a],l=0;l<h.length;l++)for(var q=
c.querySelectorAll('[data-iugo_id="'+h[l]+'"]'),n=0;n<q.length;n++)f(b,q[n],a);a=c.getElementsByClassName("bindto-"+a);for(l=0;l<a.length;l++)g(b,a[l])});$iugo.initializers.push(function(a){"click contextmenu hoverin hoverout focus blur change".split(" ").forEach(function(b){a.scope[getRealEvent(b)]=passEventToController(b,a)})});function getRealEvent(a){"hoverin"==a&&(a="mouseover");"hoverout"==a&&(a="mouseout");return"on"+a}
function nodeToPath(a){for(var b=[];a;a=a.parentNode)b.push(a);return b}function getPathFromSplit(a,b){for(var c=null,e=nodeToPath(a);b;b=b.parentNode){for(var d=0;d<e.length;d++)if(b.isEqualNode(e[d])){for(var c=[],f=0;f<d;f++)c[f]=e[f];break}if(c)break}return c}
function passEventToController(a,b,c){return function(c){var d=null;if(d="hoverin"==a||"hoverout"==a?getPathFromSplit(c.target,c.relatedTarget):"click"==a?c.path?c.path:nodeToPath(c.target):c.target)for(var f=0;f<d.length;f++){var k=d[f];if(k.isEqualNode(this))break;var g=k.getAttribute("data-"+a);if(g&&b.controller[g]instanceof Function)return b.controller[g].call(k,b,c),!1}return!0}}
window.Iugo.http={get:function(a,b,c,e){return this.xhr("get",a,void 0,{},c,e)},xhr:function(a,b,c,e,d,f,k){if(window.Promise)return new Promise(function(g,m){var h=new XMLHttpRequest;h.onload=function(){200<=this.status&&300>this.status?e instanceof Function?g(e(this.responseText)):this.getResponseHeader("content-type")?g(JSON.parse(this.responseText)):g(this.responseText):m(this)};h.onerror=h.onabort=function(){m(this)};h.open(a,b,!0,f,k);for(var l in d)d.hasOwnProperty(l)&&h.setRequestHeader(l,
d[l]);h.send(c)});console.log("To use the HTTP extension, load a Promise polyfill")}};
