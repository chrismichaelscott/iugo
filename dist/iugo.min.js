/* copyright Factmint Ltd 2014, Licence MIT, author chris.scott@factmint.com */
'use strict';window.$iugo={};$iugo.$internals={};$iugo.$internals.applyDeepGettersAndSetters=function(a,c,b){if(a instanceof Object||a instanceof Array)for(var f in a)a.hasOwnProperty(f)&&$iugo.$internals.applySetters(c,a,f,b.concat([f]));a instanceof Array&&$iugo.$internals.registerArray(a,c,b)};$iugo.$internals.setValue=function(a,c,b,f,d){window.Promise&&a instanceof Promise?a.then(function(a){f[d]=a}):(c.$[b.join(".")]=a,$iugo.$internals.applyDeepGettersAndSetters(a,c,b))};
$iugo.$internals.applySetters=function(a,c,b,f){$iugo.$internals.setValue(c[b],a,f,c,b);Object.defineProperty(c,b,{get:function(){return a.$[f.join(".")]},set:function(d){$iugo.$internals.setValue(d,a,f,c,b);a.updateView(f)}})};
$iugo.$internals.registerArray=function(a,c,b){a.push=function(){var a=Array.prototype.push.apply(this,arguments);c.model[b[0]]=c.model[b[0]];return a};a.pop=function(){var f=$iugo.$internals.clone(Array.prototype.pop.call(a));c.model[b[0]]=c.model[b[0]];return f};a.unshift=function(){for(var a=$iugo.$internals.clone(this),d=0;d<arguments.length;d++)this[d]=arguments[d];for(var e=0;e<a.length;e++)this[d++]=a[e];c.model[b[0]]=c.model[b[0]];return this.length};a.shift=function(){var a=$iugo.$internals.clone(Array.prototype.shift.call(this));
c.model[b[0]]=c.model[b[0]];return a};a.reverse=function(){for(var a=$iugo.$internals.clone(this),d=0;d<this.length;d++)this[d]=a[this.length-1-d];c.model[b[0]]=c.model[b[0]];return this};a.sort=function(){var a=$iugo.$internals.clone(this);Array.prototype.sort.apply(a,arguments);for(var d=0;d<this.length;d++)this[d]=a[d];c.model[b[0]]=c.model[b[0]];return this};a.splice=function(){for(var a=$iugo.$internals.clone(this),d=0;d<a.length,d<arguments[0];d++)this[d]=a[d];for(var e=2;e<arguments.length;e++)this[d++]=
arguments[e];for(e=arguments[0]+arguments[1];e<a.length;e++)this[d++]=a[e];for(e=d;e<a.length;e++)this.pop();c.model[b[0]]=c.model[b[0]];return this}};$iugo.$internals.clone=function(a){var c;c=a instanceof Array?[]:{};for(var b in a)c[b]=a[b]instanceof Object||a[b]instanceof Array?$iugo.$internals.clone(a[b]):a[b];return c};
$iugo.$internals.MVVC=function(a,c){this.store={};this.scope=c?c:document.body;this.controller={};this.viewcontroller={};for(var b=0;b<this.initializers.length;b++)if(this.initializers[b]instanceof Function)this.initializers[b](this);this.$={};$iugo.$internals.applySetters(this,this,"model",[]);this.model=a;this.updateView([])};
$iugo.$internals.MVVC.prototype={updateView:function(a){for(var c=0;c<this.defaultViewcontrollers.length;c++)if(this.defaultViewcontrollers[c]instanceof Function)this.defaultViewcontrollers[c](this,a);"undefined"!==typeof this.viewcontroller&&this.viewcontroller instanceof Function&&this.viewcontroller(this,a)},defaultViewcontrollers:[],initializers:[]};$iugo.defaultViewcontrollers=$iugo.$internals.MVVC.prototype.defaultViewcontrollers;$iugo.initializers=$iugo.$internals.MVVC.prototype.initializers;
window.Iugo=function(a,c){return new $iugo.$internals.MVVC(a,c)};
$iugo.initializers.push(function(a){a.store.tags={};a.store.namespacedTagIndex={};a.store.idCounter=0;for(var c=/(>[^<]*)\{\{([^}<]*)\}\}([^<]*<)/g;a.scope.innerHTML.match(c);)a.scope.innerHTML=a.scope.innerHTML.replace(c,function(a,c,d,e){return a=c+"<span "+('data-bind="'+d+'"></span>'+e)});a.scope.innerHTML=a.scope.innerHTML.replace(/<[^>]+ [^ =]+="[^"]*\{\{[^}<"]+\}\}[^"]*"[^>]*>/g,function(c){var f=a.store.idCounter++;a.store.tags[f]={bindAttributes:[],attributeTemplates:{},replacements:{}};
c=c.replace(/([^ =]+)="([^"]*\{\{[^}"]+\}\}[^"]*)"/g,function(c,b,k){"data-iugo_alias-"==b.substr(0,16)&&(b=b.substr(16));a.store.tags[f].bindAttributes.push(b);a.store.tags[f].attributeTemplates[b]=k;k.replace(/\{\{([^"}:]+):[^}"]+\}\}/g,function(c,b){a.store.namespacedTagIndex[b]||(a.store.namespacedTagIndex[b]=[]);-1==a.store.namespacedTagIndex[b].indexOf(f)&&a.store.namespacedTagIndex[b].push(f)});return b+'=""'});return c=c.replace(/ ?>$/,' data-iugo_id="'+f+'">')})});
$iugo.defaultViewcontrollers.push(function(a,c){function b(c){for(var b=document.querySelector('[data-iugo_id="'+c+'"]'),d=a.store.tags[c].bindAttributes,f=0;f<d.length;f++){var e=a.store.tags[c].attributeTemplates[d[f]].replace(k,function(b){return a.store.tags[c].replacements[b]?a.store.tags[c].replacements[b]:""});b.setAttribute(d[f],e)}}function f(c,d){if(d.hasAttribute("data-iugo_id")){for(var f=d.getAttribute("data-iugo_id"),e=function(b,d,e){var m=null,m=d?a.model[d.substr(0,d.length-1)]:c;
d=e.split(".");for(e=0;e<d.length;e++)if(""!==d[e])if(m[d[e]])m=m[d[e]];else throw"bad bind address";a.store.tags[f].replacements[b]=m},s=a.store.tags[f].bindAttributes,l=0;l<s.length;l++)a.store.tags[f].attributeTemplates[s[l]].replace(k,e);b(f)}}function d(c){var b=c.getAttribute("data-iugo_id"),d=a.store.idCounter++,b=a.store.tags[b];a.store.tags[d]={bindAttributes:b.bindAttributes,attributeTemplates:b.attributeTemplates,replacements:{}};c.setAttribute("data-iugo_id",d)}function e(c,b){var g=b.getAttribute("data-bind");
if(g){var h=g.indexOf(":");0<h&&(c=a.model[g.substr(0,h)],g=g.substr(h+1));try{g.split(".").forEach(function(a){if(""!==a)if(c[a])c=c[a];else throw"bad bind address";})}catch(k){return}}if((g=b.getAttribute("data-if"))&&(g=a.controller[g])&&g instanceof Function)if(g.call(b,c,a))g=b.getAttribute("data-iugo_olddisplay"),b.style.display=g?g:"";else{b.hasAttribute("data-iugo_olddisplay")||b.setAttribute("data-iugo_olddisplay",b.style.display);b.style.display="none";return}f(c,b);if(c instanceof Array){g=
b.children.length;for(h=g-1;0<=h;h--)b.children[h].classList.contains("iugo_cloned")&&b.removeChild(b.children[h]);g=b.children.length;for(h=0;h<g;h++){var l;if(b.children[h].hasAttribute("data-each")){l=b.children[h];0===c.length?(l.setAttribute("data-iugo_display",l.style.display),l.style.display="none"):l.style.display=l.getAttribute("data-iugo_display");for(var q=0;q<c.length;q++){var n;if(1<=q){n=l.cloneNode(!0);n.classList.add("iugo_cloned");n.hasAttribute("data-iugo_id")&&d(n);for(var t=n.querySelectorAll("[data-iugo_id]"),
r=0;r<t.length;r++)d(t[r]);b.appendChild(n)}else n=l;e(c[q],n)}}}}else if(0<b.children.length)for(h=0;h<b.children.length;h++)e(c,b.children[h]);else c instanceof Object||("INPUT"==b.tagName?b.value=c:b.innerHTML=c)}var k=/\{\{([^:}]+:)?([^}]+)\}\}/g;console.log(c);e(a.model,a.scope)});$iugo.initializers.push(function(a){"click contextmenu hoverin hoverout focus blur change".split(" ").forEach(function(c){a.scope[getRealEvent(c)]=passEventToController(c,a)})});
function getRealEvent(a){"hoverin"==a&&(a="mouseover");"hoverout"==a&&(a="mouseout");return"on"+a}function nodeToPath(a){for(var c=[];a;a=a.parentNode)c.push(a);return c}function getPathFromSplit(a,c){for(var b=null,f=nodeToPath(a);c;c=c.parentNode){for(var d=0;d<f.length;d++)if(c.isEqualNode(f[d])){for(var b=[],e=0;e<d;e++)b[e]=f[e];break}if(b)break}return b}
function passEventToController(a,c,b){return function(b){var d=null;if(d="hoverin"==a||"hoverout"==a?getPathFromSplit(b.target,b.relatedTarget):"click"==a?b.path?b.path:nodeToPath(b.target):b.target)for(var e=0;e<d.length;e++){var k=d[e];if(k.isEqualNode(this))break;var p=k.getAttribute("data-"+a);if(p&&c.controller[p]instanceof Function)return c.controller[p].call(k,b,c),!1}return!0}}
window.Iugo.http={get:function(a,c,b,f){return this.xhr("get",a,void 0,{},b,f)},xhr:function(a,c,b,f,d,e,k){if(window.Promise)return new Promise(function(p,m){var g=new XMLHttpRequest;g.onload=function(){200<=this.status&&300>this.status?f instanceof Function?p(f(this.responseText)):"application/json"==this.getResponseHeader("content-type")?p(JSON.parse(this.responseText)):p(this.responseText):m(this)};g.onerror=g.onabort=function(){m(this)};g.open(a,c,!0,e,k);for(var h in d)d.hasOwnProperty(h)&&
g.setRequestHeader(h,d[h]);g.send(b)});console.log("To use the HTTP extension, load a Promise polyfill")}};
