<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<link rel="stylesheet" href="qunit.css">  
<script type="text/javascript" src="qunit.js"></script>
<!--<script src="../iugo.min.js"></script>-->

<script src="../src/iugo-core.js"></script>
<script src="../src/iugo-bind_to_dom.js"></script>
<script src="../src/iugo-events.js"></script>
<script src="../src/iugo-http.js"></script>

<script>
window.onload = function() {
	var testCase = new Iugo({
		response: Iugo.http.get('sample.json'),
		email: "chris@factmint.com",
		name: "Chris Scott",
		friends: [
			{firstname: "Euan", surname: "Holloway", age: 29},
			{firstname: "Josie", surname: "Capell", age: 29},
			{firstname: "Alex", surname: "Parkes", age: 30}
		],
		contact: {
			telephone: "999",
			address: {
				city: "London",
				country: "UK",
				postcode: "N3 4DD"
			}
		},
		work: {
			name: "FactMint",
			telephone: "911",
			address: {
				city: "New York"
			}
		},
		websites: ["factmint.com", "chrisscott.org", "iugojs.com"],
		blogrole: ["lea.verou.me", "chrisscott.org", "css-tricks.com"],
		price: 32,
		interests: {
			books: [
				{
					author: "Jules Verne",
					title: "Around the world in 80 days"
				}
			]
		}
	},
	
	document.getElementById("testView"));
	
	testCase.controller = {
		failCondition: function() {
			return false;
		},
		successCondition: function() {
			return true;
		},
		isItFactmint: function(value) {
			return (value == 'FactMint');
		}
	}
	
	test('Simple Member Test', function() {
		var email = document.getElementById('simpleMemberTest');
		equal(email.innerHTML, "chris@factmint.com", "Simple Member bound by class");
		testCase.model.email = "chris.scott@factmint.com";
		equal(email.innerHTML, "chris.scott@factmint.com", "Updates to the model are reflected in the DOM");
	});
	
	test('Object Member Test', function() {
		var city = document.getElementById('objectMemberTest');
		equal(city.innerHTML, "London", "Object Member bound by class and key");
	});
	
	test('Object Binding Test', function() {
		var emptyObject = document.getElementById('objectFalseTest');
		equal(emptyObject.innerHTML, "", "No content is bound at the top level of an object");
		
		var myTelephone = document.getElementById('objectMemberChildElementTest');
		equal(myTelephone.innerHTML, "999", "Child elements are bound to members");
		
		var postcode = document.getElementById('variableSyntaxTest').children[0];
		ok(postcode, "Variables are substituted for nodes");
		equal(postcode.tagName, "SPAN", "Variables are substituted for <span> tags");
		equal(postcode.attributes[0].name, "data-bind", "Variable span tags have a bind key");
		equal(postcode.attributes[0].value, "address.postcode", "The variable's bind key is set correctly");
		equal(postcode.innerHTML, "N3 4DD", "The variable span tag is bound to a member");
		
		var workCity = document.getElementById('variableSyntaxNamespaceTest').children[0];
		ok(workCity, "Namespaced variables are substituted for nodes");
		equal(workCity.getAttribute('data-bind'), 'work:address.city', "The namespaced variable's span is bound to a top-level model");
		equal(workCity.innerHTML, "New York", "The namespaces variable span tag is bound to a member");
		
		var workTelephone = document.getElementById('variableSyntaxNamespaceTest').children[1];
		ok(workTelephone, "Multiple variables are all sumstituted");
		equal(workTelephone.innerHTML, "911", "The second namespaces variable tag is bound to a member");
		
		var name = document.getElementById('variableSyntaxNamespaceOnlyTest').children[0];
		ok(name, "A variable with a namespace and no address is still bound to a simple variable");
		equal(name.innerHTML, "Chris Scott", "The simple variable is adressed by namespace alone");
	});
		
	test('Regex validity test', function() {
		var priceSentence = document.getElementById('variableSyntaxDollarTest')
		var price = priceSentence.children[0];
		ok(price, "Variables are substituted for nodes, even with $ characters in the string");
		equal(priceSentence.innerHTML.charAt(6), "$", "The dollar ($) character is left intact");

		var messySentence = document.getElementById('variableSyntaxMessyTest')
		equal(messySentence.children.length, 3, "Substitutions are correct in strings with dollars and braces.");
	});
	
	test('Simple List Binding Test', function() {
		var list = document.getElementById('simpleListTest').children;
		equal(list.length, 3, "Each element for a list is bound by the data-each attribute");
		ok(list[0].innerHTML == "factmint.com" && list[1].innerHTML == "chrisscott.org" && list[2].innerHTML == "iugojs.com", "All elements from the list are bound correctly");
		
		testCase.model.websites.reverse();
		var list = document.getElementById('simpleListTest').children;
		ok(list[0].innerHTML == "iugojs.com" && list[1].innerHTML == "chrisscott.org" && list[2].innerHTML == "factmint.com", "All elements from the list are bound correctly after the array is reversed");
		
		testCase.model.websites.push("foodyfare.com");
		var list = document.getElementById('simpleListTest').children;
		equal(list.length, 4, "Elements can be pushed onto the array in the model");
		equal(list[3].innerHTML, "foodyfare.com", "Changes to the array are mapped to the DOM");
		
		testCase.model.websites.sort();
		var list = document.getElementById('simpleListTest').children;
		ok(list[0].innerHTML == "chrisscott.org" && list[1].innerHTML == "factmint.com" && list[2].innerHTML == "foodyfare.com" && list[3].innerHTML == "iugojs.com", "All elements from the list are bound correctly after the array is sorted");
		
		testCase.model.websites.splice(1, 2, "google.com");
		var list = document.getElementById('simpleListTest').children;
		ok(list[0].innerHTML == "chrisscott.org" && list[1].innerHTML == "google.com" && list[2].innerHTML == "iugojs.com", "All elements from the list are bound correctly after the array is spliced");
		
		testCase.model.websites.unshift("factmint.com");
		var list = document.getElementById('simpleListTest').children;
		ok(list[0].innerHTML == "factmint.com" && list[1].innerHTML == "chrisscott.org" && list[2].innerHTML == "google.com" && list[3].innerHTML == "iugojs.com", "All elements from the list are bound correctly after an element is unshifted");
		
		testCase.model.websites.pop();
		var list = document.getElementById('simpleListTest').children;
		ok(list[0].innerHTML == "factmint.com" && list[1].innerHTML == "chrisscott.org" && list[2].innerHTML == "google.com", "All elements from the list are bound correctly after an element is popped");
		
		testCase.model.websites.shift();
		var list = document.getElementById('simpleListTest').children;
		ok(list[0].innerHTML == "chrisscott.org" && list[1].innerHTML == "google.com", "All elements from the list are bound correctly after an element is shifted");
	});
	
	test('Dot syntax List Binding Test', function() {
		var list = document.getElementById('dotVariableListTest').children;
		equal(list.length, 3, "Each element for a list is bound by the data-each attribute");
		equal(list[0].getElementsByTagName("a")[0].getAttribute("href"), "http://lea.verou.me", "The dot syntax works in attributes");
		equal(list[1].getElementsByTagName("span")[0].innerHTML, "chrisscott.org", "The dot syntax works for binding innerHTML");
	});
	
	test('Object List Test', function() {
		var friendList = document.getElementById('objectListTest').children;
		equal(friendList.length, 3, "All of the objects from the list are repeated in the DOM");
		ok(friendList[0].innerHTML == "Euan" && friendList[1].innerHTML == "Josie" && friendList[2].innerHTML == "Alex", "All values from the objects are mapped to the appropriate bind key");
		
		var deepFriendsList = document.getElementById('objectDeepListTest').children;
		equal(deepFriendsList.length, 3, "All of the objects from the list are repeated as child DOM trees");
		var alex = deepFriendsList[2].children;
		ok(alex[0].innerHTML == "Alex" && alex[1].innerHTML == "Parkes", "The child nodes with bind keys have been mapped");
		equal(alex.length, 3, "The variable syntax has been added to the child DOM tree");
		equal(alex[2].attributes[0].name, "data-bind", "A bind key has been added to the variable syntax span");
		equal(alex[2].attributes[0].value, "age", "The bind key has been set successfully from the variable syntax");
		equal(alex[2].innerHTML, "30", "The variable syntax span has been mapped correctly");
		
		testCase.model.friends.reverse();
		var euan = deepFriendsList[2].children;
		ok(euan[0].innerHTML == "Euan" && euan[1].innerHTML == "Holloway", "After reversing, the child nodes with bind keys have been mapped");
		equal(euan.length, 3, "After reversing, the variable syntax has been added to the child DOM tree");
		equal(euan[2].innerHTML, "29", "After reversing, the variable syntax span has been mapped correctly");
		
		var secondLevelList = document.getElementById('secondLevelListTest').children;
		equal(secondLevelList.length, 1, "All of the objects from the second level list are repeated as child DOM trees");
		var jules = secondLevelList[0];
		equal(jules.innerHTML, "Jules Verne", "The child nodes with bind keys, from the second level list, have been mapped");
		
		var secondLevelDeepList = document.getElementById('secondLevelDeepListTest').children;
		var title = secondLevelDeepList[0].children[0];
		equal(title.innerHTML, "Around the world in 80 days", "The child nodes with bind keys, from the second level list, have been mapped from the list");
	});
	
	test('Attribute Binding Test', function() {
		var country = document.getElementById('attributeBindTest').getAttribute('data-country');
		equal(country, "UK", "A variable in an attribute has been substituted for the value in the model");
		
		var country2 = document.getElementById('attributeBindNamespaceTest').getAttribute('data-country');
		equal(country2, "UK", "A namespaced variable in an attribute has been substit for the value in the model");
		
		var countryImage = document.getElementById('attributeBindInjectTest').getAttribute('src');
		equal(countryImage, "images/FactMint", "A value from the model has been injected into an attribute replacing the variable but keeping the surrounding content");
		
		var countryImage2 = document.getElementById('attributeBindAliasTest').getAttribute('src');
		equal(countryImage2, "images/FactMint", "A value from the model has been injected into an attribute by an alias");
		
		var location = document.getElementById('attributeMultiBindTest').getAttribute('data-location');
		equal(location, "UK New York", "Multiple variables are substituted in an attribute");
		
		var city = document.getElementById('multiAttributeBindTest').getAttribute('data-city');
		var work = document.getElementById('multiAttributeBindTest').getAttribute('data-work');
		ok(city == "London" && work == "FactMint", "Multiple attributes are processed within one tag");
		
		// Update the model to check the changes are reflected
		testCase.model.work.name = "FactMint Ltd";
		
		work = document.getElementById('multiAttributeBindTest').getAttribute('data-work');
		equal(work, "FactMint Ltd", "Updates to the model are reflected in attributes with variables");
		
		countryImage = document.getElementById('attributeBindInjectTest').getAttribute('src');
		equal(countryImage, "images/FactMint Ltd", "Updates to the model are reflected in attributes with variables and surrounding text");
		
	});
	
	test('Attribute Binding with Lists', function() {
		var friends = document.getElementById("attributeBindingInListTest").children;
		equal(friends[0].children[0].getAttribute("href"), friends[0].children[0].children[0].innerHTML, "The attribute bindings match the inner HTML bindings for the first element in list");
		equal(friends[1].children[0].getAttribute("href"), friends[1].children[0].children[0].innerHTML, "The attribute bindings match the inner HTML bindings for the second element in list");
		equal(friends[2].children[0].getAttribute("href"), friends[2].children[0].children[0].innerHTML, "The attribute bindings match the inner HTML bindings for the third element in list");
		
		testCase.model.friends.reverse();
		
		equal(friends[0].children[0].getAttribute("href"), friends[0].children[0].children[0].innerHTML, "After reversing, the attribute bindings match the inner HTML bindings for the first element in list");
		equal(friends[1].children[0].getAttribute("href"), friends[1].children[0].children[0].innerHTML, "After reversing, the attribute bindings match the inner HTML bindings for the second element in list");
		equal(friends[2].children[0].getAttribute("href"), friends[2].children[0].children[0].innerHTML, "After reversing, the attribute bindings match the inner HTML bindings for the third element in list");
		
	});
	
	test('Conditional DOM', function() {
		var nodes = document.getElementById('condition-test').children;
		equal(nodes[0].getAttribute('style'), 'display: none', 'the test was false');
		notEqual(nodes[1].getAttribute('style'), 'display: none', 'the test was true');

		notEqual(nodes[2].style.display, 'none', 'the test was true, as the value was "FactMint"');
		equal(nodes[3].style.display, 'none', 'the test was false, as the value was not "FactMint"');
	});
	
	asyncTest('HTTP Promise resolution', function() {
		expect(1);
		
		setTimeout(function() {
			var sport = document.getElementById("http-test").children[0];
		
			equal(sport.innerHTML, "golf", "The HTTP request was resolved");
			start();
		}, 1000);
	});
};
</script>
<style>
	#testView {
		display: none;
	}
</style>
</head>
<body>
	<div id="testView">
		<span data-bind="email" id="simpleMemberTest"></span>
		<span data-bind="contact.address.city" id="objectMemberTest"></span>
		<div data-bind="contact" id="objectFalseTest"></div>
		<div data-bind="contact">
			<span data-bind="telephone" id="objectMemberChildElementTest"></span>
			<span id="variableSyntaxTest">My post code is {{address.postcode}}.</span>
			<span id="variableSyntaxNamespaceTest">In {{work:address.city}} the Emergency Serives are on {{work:telephone}}</span>
			<span id="variableSyntaxNamespaceOnlyTest">My name is {{name:}}</span>
		</div>
		<span id="variableSyntaxDollarTest">price ${{price}}.</span>
		<span id="variableSyntaxMessyTest">${{price}} $ {{price}} } { {{price}}</span>
		<ul data-bind="websites" id="simpleListTest">
			<li data-each></li>
		</ul>
		<ul data-bind="blogrole" id="dotVariableListTest">
			<li data-each>
				<a href="http://{{.}}">Go to {{.}}</a>
			</li>
		</ul>
		<ul data-bind="friends" id="objectListTest">
			<li data-each data-bind="firstname"></li>
		</ul>
		<ul data-bind="friends" id="objectDeepListTest">
			<li data-each>
				<span data-bind="firstname"></span>
				<span data-bind="surname"></span>
				is {{age}} years old
			</li>
		</ul>
		<div data-bind="interests">
			<ul data-bind="books" id="secondLevelListTest">
				<li data-each data-bind="author"></li>
			</ul>
		</div>
		<div data-bind="interests">
			<ul data-bind="books" id="secondLevelDeepListTest">
				<li data-each>
					<span data-bind="title"></span>
				</li>
			</ul>
		</div>
		<div data-bind="contact" data-country="{{address.country}}" id="attributeBindTest"></div>
		<div data-country="{{contact:address.country}}" id="attributeBindNamespaceTest"></div>
		<img src="images/{{work:name}}" id="attributeBindInjectTest"></img>
		<img data-iugo_alias-src="images/{{work:name}}" id="attributeBindAliasTest"></img>
		<div data-bind="contact" data-location="{{address.country}} {{work:address.city}}" id="attributeMultiBindTest"></div>
		<div data-bind="contact" data-city="{{address.city}}" data-work="{{work:name}}" id="multiAttributeBindTest"></div>
		<ul data-bind="friends" id="attributeBindingInListTest">
			<li data-each>
				<a href="{{firstname}}">{{firstname}}</a>
			</li>
		</ul>
		
		<section data-bind="response" id="http-test">
			{{sport}}
		</section>
		
		<section data-bind="work" id="condition-test">
			<div data-if="failCondition">no</div>
			<div data-if="successCondition">yes</div>
			<div data-bind="name" data-if="isItFactmint">yes</div>
			<div data-bind="telephone" data-if="isItFactmint">yes</div>
		</section>
	</div>
	<h1 id="qunit-header">iugo MVVC test coverage</h1>  
	<h2 id="qunit-banner"></h2>  
	<div id="qunit-testrunner-toolbar"></div>  
	<h2 id="qunit-userAgent"></h2>  
	<ol id="qunit-tests"></ol>
</body>
</html>
